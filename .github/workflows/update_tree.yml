name: Update Project Tree

on:
  push:
    branches:
      - main

jobs:
  update-project-tree:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Set up Python for generating project tree
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      # Generate project tree in Markdown format
      - name: Generate project tree
        run: |
          mkdir -p artifacts
          python scripts/generate_tree.py
          mv data/project_tree.md artifacts/project_tree.md

      # Convert Markdown to HTML
      - name: Convert Markdown to HTML
        run: |
          pandoc -f markdown -t html data/project_tree.md -o artifacts/project_tree.html

      # Upload HTML content to Confluence
      - name: Upload project tree to Confluence
        env:
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
        run: |
          # Define variables
          SPACE_KEY="NEW_SPACE_KEY" # Cambia esto por el nuevo Space Key
          PAGE_ID="NEW_PAGE_ID"     # Cambia esto por el nuevo Page ID
          SITE_URL="https://new-site.atlassian.net/wiki" # Cambia esto por tu nuevo site
          USER_EMAIL="your-email@gmail.com" # Ajusta si el email ha cambiado
          FILE_PATH="artifacts/project_tree.html"

          # Read HTML content
          CONTENT=$(cat $FILE_PATH)

          # Upload to Confluence using API
          curl -X PUT \
            -H "Authorization: Basic $(echo -n $USER_EMAIL:$CONFLUENCE_API_TOKEN | base64)" \
            -H "Content-Type: application/json" \
            -d "{\"version\":{\"number\":2},\"title\":\"Project Tree\",\"type\":\"page\",\"body\":{\"storage\":{\"value\":\"$CONTENT\",\"representation\":\"storage\"}}}" \
            "$SITE_URL/rest/api/content/$PAGE_ID"
